<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markerless AR with Three.js and WebXR</title>
    <style>
        body { margin: 0; overflow: hidden; display: flex; height: 100vh; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            background: white;
            padding: 5px;
        }
        #sidebar {
            width: 200px;
            background: white;
            padding: 10px;
            overflow-y: auto;
            z-index: 1;
            height: 100vh; /* Ensure the sidebar takes the full height */
        }
        #sidebar img {
            width: 100%;
            height: auto;
            cursor: grab;
            display: block;
            margin-bottom: 10px;
        }
        #ar-container {
            flex-grow: 1;
            position: relative;
            cursor: crosshair;
        }
        canvas {
            display: block;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/webxr/ARButton.js"></script>
</head>
<body>
    <div id="sidebar"></div>
    <div id="ar-container">
        <div id="info">Drag an image to place a 3D object.</div>
    </div>
    <script>
        // Fetch products from the server and render the sidebar
        fetch('indexing.php')
            .then(response => response.json())
            .then(data => {
                const sidebar = document.getElementById('sidebar');
                data.forEach(product => {
                    const productDiv = document.createElement('div');
                    const productImg = document.createElement('img');
                    productImg.src = product.product_image;
                    productImg.alt = product.product_name;
                    productImg.draggable = true;
                    productImg.dataset.name = product.product_name;
                    productImg.dataset.image = product.product_image;

                    const productName = document.createElement('h3');
                    productName.textContent = product.product_name;
                    const productQuantity = document.createElement('p');
                    productQuantity.textContent = `Quantity: ${product.quantity}`;

                    productDiv.appendChild(productName);
                    productDiv.appendChild(productImg);
                    productDiv.appendChild(productQuantity);
                    sidebar.appendChild(productDiv);

                    // Handle drag start event
                    productImg.addEventListener('dragstart', function (event) {
                        event.dataTransfer.setData('text/plain', JSON.stringify({
                            name: product.product_name,
                            image: product.product_image
                        }));
                    });
                });
            });

        let scene, camera, renderer;
        let video, videoTexture;
        let objects = [];

        init();
        animate();

        function init() {
            // Set up the scene
            scene = new THREE.Scene();

            // Set up the camera
            camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 200) / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // Set up the renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth - 200, window.innerHeight); // Adjust width for sidebar
            document.getElementById('ar-container').appendChild(renderer.domElement);

            // Set up the video element
            video = document.createElement('video');
            video.autoplay = true;
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                });

            videoTexture = new THREE.VideoTexture(video);
            const videoMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });

            const planeGeometry = new THREE.PlaneGeometry(16, 9);
            planeGeometry.scale(0.5, 0.5, 0.5);
            const plane = new THREE.Mesh(planeGeometry, videoMaterial);
            scene.add(plane);

            // Add event listener for placing objects
            document.addEventListener('dragover', onDocumentDragOver, false);
            document.addEventListener('drop', onDocumentDrop, false);
        }

        function onDocumentDragOver(event) {
            event.preventDefault();
        }

        function onDocumentDrop(event) {
            event.preventDefault();

            const productData = JSON.parse(event.dataTransfer.getData('text/plain'));
            const textureLoader = new THREE.TextureLoader();
            
            textureLoader.load(productData.image, function(texture) {
                const geometry = new THREE.PlaneGeometry(1, 1);
                const material = new THREE.MeshBasicMaterial({ map: texture });
                const imagePlane = new THREE.Mesh(geometry, material);

                // Convert screen coordinates to Three.js coordinates
                const rect = renderer.domElement.getBoundingClientRect();
                const mouse = new THREE.Vector2();
                mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;
                mouse.y = -(event.clientY - rect.top) / rect.height * 2 + 1;

                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children, true);

                if (intersects.length > 0) {
                    const intersect = intersects[0];
                    imagePlane.position.copy(intersect.point);
                    imagePlane.position.z = 0; // Set z position to 0 to place on the ground
                } else {
                    imagePlane.position.set(mouse.x * 5, mouse.y * 5, 0);
                }

                scene.add(imagePlane);
                objects.push(imagePlane);
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // Update the video texture
            if (video.readyState >= video.HAVE_CURRENT_DATA) {
                videoTexture.needsUpdate = true;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
